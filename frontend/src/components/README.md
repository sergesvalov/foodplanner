# Расчет КБЖУ в рецептах

В этом документе описана логика расчета калорийности, белков, жиров и углеводов для рецептов.
Расчет производится на бэкенде (файл `backend/models.py`, метод `_calculate_nutrient`).

## Основной принцип
Итоговое значение нутриента (например, калорий) для рецепта — это сумма значений этого нутриента для всех ингредиентов.

```
Total = Sum(Ingredient_Nutrition)
```

## Логика расчета для ингредиента

Логика зависит от единицы измерения продукта и наличия веса одной штуки.

### 1. Продукты в граммах (г) или миллилитрах (мл)
Значение в базе данных (БД) хранится на **100 единиц (100г или 100мл)**.

$$
Value = Qty \times \frac{ValuePer100}{100}
$$

### 2. Продукты в килограммах (кг) или литрах (л)
Количество автоматически переводится в граммы/миллилитры (умножается на 1000).
Значение в БД хранится на **100г/мл**.

$$
Value = (Qty \times 1000) \times \frac{ValuePer100}{100}
$$

### 3. Продукты в штуках (шт/pcs)

Здесь есть два варианта:

#### А. У продукта указан вес одной штуки (`weight_per_piece`)
Если вес штуки задан, мы считаем, что значение нутриентов в БД указано **на 100г продукта**.
Сначала вычисляется общий вес всех штук, затем применяется формула для граммов.

$$
TotalWeight = Qty \times WeightPerPiece
$$
$$
Value = TotalWeight \times \frac{ValuePer100}{100}
$$

*Пример: 2 банана, вес одного 150г, калорийность 89 ккал/100г.*
*Вес = 300г. Калории = 300 * (89/100) = 267 ккал.*

#### Б. Вес одной штуки НЕ указан
Если вес штуки не задан (0 или null), мы считаем, что значение нутриентов в БД указано **за 1 штуку**.

$$
Value = Qty \times ValuePerPiece
$$

*Пример: 1 яйцо, калорийность в БД 70 (за штуку).*
*Калории = 1 * 70 = 70 ккал.*

---

## Итоговый расчет на порцию
Итоговые значения для рецепта делятся на количество порций, указанное при создании рецепта.

$$
PerPortion = \frac{TotalSuma}{Portions}
$$
